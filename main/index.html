<html>
  <head>
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
	<style type="text/css">
	  html { height: 100% }
	  body { height: 100%; margin: 0; padding: 0 }
	  #map_canvas { height: 100% }
	</style>
	<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
	<script type="text/javascript">
	  // Request Objects
	function $() { 
	  return document.getElementById(arguments[0]);
	}
	function $F() { 
	  return document.getElementById(arguments[0]).value;
	}

	function relocate(lat, lng) {
	  this.Op = "cMove";
	  this.Lat = lat;
	  this.Lng = lng;
	}

	function init(name, lat, lng) {
	  this.Op = "cInit"
	  this.Name = name;
	  this.Lat = lat;
	  this.Lng = lng;
	}

	function nearby(lat, lng) {
	  this.Op = "cNearby";
	  this.Lat = lat;
	  this.Lng = lng;
	}

	function clientObj() {
	  return {
		connect: function() {
		  this.ws=new WebSocket("ws://localhost:8001/ws");
			this.ws.onopen=this.onopen;
			this.ws.onmessage=this.onmessage;
			this.ws.onclose=this.onclose;
		},  
		onopen: function() {
		  console.log("Websocket Connection Open!")
		},  
		send: function(obj) {
		  msg = JSON.stringify(obj)
		  console.log(msg);
		  if (this.ws) this.ws.send(msg);
		},  
		onmessage: function(m) { 
		  if (m.data) {
			console.log(m.data);
			var msg = JSON.parse(m.data);
			processMessage(msg);
		  }
		},  
		onclose: function(m) {
		  console.log("Websocket Connection Closed!");
		  this.ws=null;
		} 
	  };
	}

	var initialised = false;
	var map;
	var marker = null;
	var client = new clientObj();
	var users = new Array();

	function initialise() {
	  client.connect();
	  var latlng = new google.maps.LatLng(54.97784, -1.612916);
	  var myOptions = {control: false,
		zoom: 15,
		center: latlng,
		mapTypeId: google.maps.MapTypeId.ROADMAP
	  };
	  map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);

	  google.maps.event.addListener(map, 'click', function(event) {
		placeMarker(event.latLng);});
	}

	function processMessage(msg) {
	  var op = msg.Op;
	  var usr = msg.Usr;
	  if (op == "sAdd" || op == "sMoved" || op == "sNearby" || op == "sVisible") {
		if (users[usr.Name]) {
			users[usr.Name].setMap(null);
		}
		var loc = new google.maps.LatLng(usr.Lat, usr.Lng);
		users[usr.Name] = new google.maps.Marker({position: loc, map: map, title: usr.Name});
	  } else if (op == "sRemove" || op == "sNotVisible") {
		users[usr.Name].setMap(null);
	  }
	}

	function placeMarker(loc) {
	  console.log("Click!")
	  if (marker != null) {
		marker.setMap(null);
	  }
	  marker = new google.maps.Marker({position:loc, map: map, title: "This is me!"});
	  sendMsg(loc);
	}

	function sendMsg(loc) {
	  var msg;
	  if (!initialised) {
		msg = new init($F("name"), loc.lat(), loc.lng());
		initialised = true;
	  } else {
		msg = new relocate(loc.lat(),loc.lng());
	  }
	  client.send(msg);
	}

  </script>
</head>
<body onLoad="initialise()">
  <h1>Set Name</h1>
  <div id="name-entry">
	<input type="text" id="name" name="name"/>
	<input visibility="visible" type="submit" id="set_name" name="Set Name" onClick='$("name-entry").style.display="none"'/>
  </div>
  <div id="map_canvas" style="width:50%; height:50%"></div>
</body>
</html>
